---
import Layout from '../layouts/Layout.astro';
import PodcastShowSwitcher from '../components/PodcastShowSwitcher.jsx';

const rssFeed = 'https://tobyonfitnesstech.com/podcasts/feed.xml';
const feedUrl = 'https://grayking-creator.github.io/openclaw-podcast/feed.xml';

interface Episode {
  episodeNum: number;
  title: string;
  description: string;
  pubDate: string;
  audioUrl: string;
  duration: string;
  showNotesUrl: string;
  coverImage: string;
}

function formatDate(raw: string): string {
  try {
    const d = new Date(raw);
    return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
  } catch {
    return raw;
  }
}

function extractTag(xml: string, tag: string): string {
  const re = new RegExp(`<${tag}[^>]*><!\\[CDATA\\[([\\s\\S]*?)\\]\\]><\\/${tag}>|<${tag}[^>]*>([\\s\\S]*?)<\\/${tag}>`, 'i');
  const m = xml.match(re);
  return (m ? (m[1] ?? m[2] ?? '') : '').trim();
}

function extractAttr(xml: string, tag: string, attr: string): string {
  const re = new RegExp(`<${tag}[^>]*\\s${attr}="([^"]*)"`, 'i');
  const m = xml.match(re);
  return m ? m[1].trim() : '';
}

function mdUrlToGitHub(url: string): string {
  const m = url.match(/https:\/\/([^.]+)\.github\.io\/([^/]+)\/(.+)/);
  if (m) {
    return `https://github.com/${m[1]}/${m[2]}/blob/main/${m[3]}`;
  }
  return url;
}

let episodes: Episode[] = [];
let fetchError = false;

try {
  const res = await fetch(feedUrl);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const xml = await res.text();

  const channelMatch = xml.match(/<channel[^>]*>([\s\S]*?)<\/channel>/i);
  const channelXml = channelMatch ? channelMatch[1] : xml;

  const itemRegex = /<item>([\s\S]*?)<\/item>/gi;
  let m: RegExpExecArray | null;

  while ((m = itemRegex.exec(channelXml)) !== null) {
    const item = m[1];

    const title = extractTag(item, 'title');
    const description = extractTag(item, 'description');
    const pubDateRaw = extractTag(item, 'pubDate');
    const audioUrl = extractAttr(item, 'enclosure', 'url');
    const duration = extractTag(item, 'itunes:duration');
    const episodeNumStr = extractTag(item, 'itunes:episode');
    const link = extractTag(item, 'link');
    const showNotesUrl = mdUrlToGitHub(link);
    const pubDate = formatDate(pubDateRaw);
    const episodeNum = parseInt(episodeNumStr, 10) || 0;
    const coverImage = `/images/podcast/episode_${String(episodeNum).padStart(3, '0')}_cover.png`;

    episodes.push({ episodeNum, title, description, pubDate, audioUrl, duration, showNotesUrl, coverImage });
  }

  episodes.sort((a, b) => b.episodeNum - a.episodeNum);

} catch (err) {
  fetchError = true;
  console.error('[podcasts.astro] RSS fetch failed:', err);
}
---

<Layout title="Podcasts | Toby on Fitness Tech" description="OpenClaw Daily ‚Äî your AI-hosted podcast covering the latest in fitness tech, local AI, hardware, and the OpenClaw ecosystem. Hosted by Nova & Alloy.">
  <div class="max-w-4xl mx-auto px-4 py-12">

    <!-- Hero -->
    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-blue-500 to-purple-500 bg-clip-text text-transparent">
        üéôÔ∏è OpenClaw Podcasts
      </h1>
      <p class="text-neutral-400 text-lg mb-6 max-w-2xl mx-auto">
        AI-hosted daily episodes covering fitness tech, local AI, hardware, security, and the OpenClaw ecosystem ‚Äî fresh takes every day.
      </p>
      <!-- Hosts badge -->
      <span class="bg-blue-500/10 border border-blue-500/20 text-blue-300 text-sm px-3 py-1 rounded-full inline-block">
        üé§ Hosts: Nova &amp; Alloy
      </span>
    </div>

    <!-- RSS Subscribe card -->
    <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 mb-10 flex flex-col sm:flex-row items-start sm:items-center gap-3">
      <div class="flex-1">
        <p class="text-blue-400 text-sm font-semibold mb-1">üì° Subscribe via RSS</p>
        <code class="text-neutral-300 text-xs break-all select-all">{rssFeed}</code>
      </div>
      <a
        href={rssFeed}
        target="_blank"
        rel="noopener noreferrer"
        class="shrink-0 bg-blue-600 hover:bg-blue-500 text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors"
      >
        Open Feed
      </a>
    </div>

    <!-- Show Switcher + Episode List (React island) -->
    <PodcastShowSwitcher
      episodes={episodes}
      fetchError={fetchError}
      client:load
    />

    <!-- Footer note -->
    <p class="text-center text-neutral-600 text-xs mt-12">
      Episodes generated by OpenClaw AI ¬∑ Voices by OpenAI TTS
    </p>

  </div>
</Layout>
