---
import Layout from '../layouts/Layout.astro';
import PodcastShowSwitcher from '../components/PodcastShowSwitcher.jsx';

const rssFeed = 'https://tobyonfitnesstech.com/podcasts/feed.xml';
const feedUrl = 'https://grayking-creator.github.io/openclaw-podcast/feed.xml';
const pocketcastsUrl = 'https://pca.st/qdsn1ef7';

interface Episode {
  episodeNum: number;
  title: string;
  description: string;
  pubDate: string;
  audioUrl: string;
  duration: string;
  showNotesUrl: string;
  coverImage: string;
}

function formatDate(raw: string): string {
  try {
    const d = new Date(raw);
    return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
  } catch {
    return raw;
  }
}

function extractTag(xml: string, tag: string): string {
  const re = new RegExp(`<${tag}[^>]*><!\\[CDATA\\[([\\s\\S]*?)\\]\\]><\\/${tag}>|<${tag}[^>]*>([\\s\\S]*?)<\\/${tag}>`, 'i');
  const m = xml.match(re);
  return (m ? (m[1] ?? m[2] ?? '') : '').trim();
}

function extractAttr(xml: string, tag: string, attr: string): string {
  const re = new RegExp(`<${tag}[^>]*\\s${attr}="([^"]*)"`, 'i');
  const m = xml.match(re);
  return m ? m[1].trim() : '';
}

function mdUrlToGitHub(url: string): string {
  const m = url.match(/https:\/\/([^.]+)\.github\.io\/([^/]+)\/(.+)/);
  if (m) {
    return `https://github.com/${m[1]}/${m[2]}/blob/main/${m[3]}`;
  }
  return url;
}

let episodes: Episode[] = [];
let fetchError = false;

try {
  const res = await fetch(feedUrl);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const xml = await res.text();
  
  const channelMatch = xml.match(/<channel[^>]*>([\s\S]*?)<\/channel>/i);
  const channelXml = channelMatch ? channelMatch[1] : xml;
  
  const itemRegex = /<item>([\s\S]*?)<\/item>/gi;
  let m: RegExpExecArray | null;
  
  while ((m = itemRegex.exec(channelXml)) !== null) {
    const item = m[1];
    const title = extractTag(item, 'title');
    const description = extractTag(item, 'description');
    const pubDateRaw = extractTag(item, 'pubDate');
    const audioUrl = extractAttr(item, 'enclosure', 'url');
    const duration = extractTag(item, 'itunes:duration');
    const episodeNumStr = extractTag(item, 'itunes:episode');
    const link = extractTag(item, 'link');
    const showNotesUrl = mdUrlToGitHub(link);
    const pubDate = formatDate(pubDateRaw);
    const episodeNum = parseInt(episodeNumStr, 10) || 0;
    const coverImage = `/images/podcast/episode_${String(episodeNum).padStart(3, '0')}_cover.png`;
    
    episodes.push({ episodeNum, title, description, pubDate, audioUrl, duration, showNotesUrl, coverImage });
  }
  
  episodes.sort((a, b) => b.episodeNum - a.episodeNum);
} catch (err) {
  fetchError = true;
  console.error('[podcasts.astro] RSS fetch failed:', err);
}

const FITNESS_FEED = 'https://anchor.fm/s/108bc95a4/podcast/rss';
const FITNESS_COVER = 'https://d3t3ozftmdmh3i.cloudfront.net/staging/podcast_uploaded_nologo/44315441/44315441-1769259381156-db3a704d94734.jpg';

interface FitnessEpisode {
  index: number;
  title: string;
  description: string;
  pubDate: string;
  audioUrl: string;
  duration: string;
  spotifyUrl: string;
  coverImage: string;
}

let fitnessEpisodes: FitnessEpisode[] = [];
let fitnessFetchError = false;

try {
  const fitnessRes = await fetch(FITNESS_FEED);
  if (!fitnessRes.ok) throw new Error(`HTTP ${fitnessRes.status}`);
  const fitnessXml = await fitnessRes.text();
  
  const fitnessItems = fitnessXml.match(/<item>([\s\S]*?)<\/item>/g) ?? [];
  
  fitnessItems.forEach((item, idx) => {
    const title = extractTag(item, 'title');
    const rawDesc = extractTag(item, 'description');
    const description = rawDesc
      .replace(/<[^>]+>/g, ' ')
      .replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&#39;/g, "'")
      .replace(/\s+/g, ' ').trim()
      .slice(0, 300) + (rawDesc.length > 300 ? '‚Ä¶' : '');
    const pubDateRaw = extractTag(item, 'pubDate');
    const pubDate = formatDate(pubDateRaw);
    const audioUrl = extractAttr(item, 'enclosure', 'url');
    const duration = extractTag(item, 'itunes:duration');
    const spotifyUrl = extractTag(item, 'link');
    
    fitnessEpisodes.push({ index: idx + 1, title, description, pubDate, audioUrl, duration, spotifyUrl, coverImage: FITNESS_COVER });
  });
} catch (err) {
  fitnessFetchError = true;
  console.error('[podcasts.astro] Fitness RSS failed:', err);
}
---

<Layout title="Podcasts | Toby on Fitness Tech" description="OpenClaw Daily ‚Äî your AI-hosted podcast covering the latest in fitness tech, local AI, hardware, and the OpenClaw ecosystem. Hosted by Nova & Alloy.">
  <div class="max-w-4xl mx-auto px-4 py-12">
    <!-- Hero -->
    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-blue-500 to-purple-500 bg-clip-text text-transparent">
        üéôÔ∏è OpenClaw Podcasts
      </h1>
      <p class="text-neutral-400 text-lg mb-6 max-w-2xl mx-auto">
        AI-hosted daily episodes covering fitness tech, local AI, hardware, security, and the OpenClaw ecosystem ‚Äî fresh takes every day.
      </p>
    </div>

    <!-- Toby on Fitness Tech Tab -->
    <div class="mb-12">
      <h2 class="text-2xl font-bold mb-6 text-center">Toby on Fitness Tech</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {fitnessEpisodes.map((episode) => (
          <a href={`/podcasts/toft-${episode.index}`} class="block bg-neutral-800 rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition-shadow duration-300">
            <div class="flex">
              <div class="flex-shrink-0 w-24 h-24">
                <img src={episode.coverImage} alt={episode.title} class="w-full h-full object-cover" />
              </div>
              <div class="p-4 flex-1">
                <h3 class="font-bold text-lg mb-1 line-clamp-2">{episode.title}</h3>
                <div class="flex items-center text-sm text-neutral-400 mb-2">
                  <span>{episode.pubDate}</span>
                  <span class="mx-2">‚Ä¢</span>
                  <span>{episode.duration}</span>
                </div>
                <p class="text-neutral-300 text-sm line-clamp-2">{episode.description}</p>
              </div>
            </div>
          </a>
        ))}
      </div>
      <div class="text-center mt-6">
        <a href="https://anchor.fm/tobyonfitnesstech" target="_blank" class="inline-flex items-center px-4 py-2 bg-neutral-700 text-neutral-200 rounded-lg hover:bg-neutral-600 transition-colors">
          <span>Subscribe on Anchor</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
          </svg>
        </a>
      </div>
    </div>

    <!-- Show Switcher + Episode List (React island) -->
    <PodcastShowSwitcher
      episodes={episodes}
      fetchError={fetchError}
      fitnessEpisodes={fitnessEpisodes}
      fitnessFetchError={fitnessFetchError}
      pocketcastsUrl={pocketcastsUrl}
      client:load
    />

    <!-- Footer note -->
    <p class="text-center text-neutral-600 text-xs mt-12">
      Episodes generated by OpenClaw AI ¬∑ Voices by OpenAI TTS
    </p>
  </div>
</Layout>
