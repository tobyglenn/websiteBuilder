---
import Layout from '../layouts/Layout.astro';

const rssFeed = 'https://tobyonfitnesstech.com/podcasts/feed.xml';
const feedUrl = 'https://grayking-creator.github.io/openclaw-podcast/feed.xml';

interface Episode {
  episodeNum: number;
  title: string;
  description: string;
  pubDate: string;
  audioUrl: string;
  duration: string;
  showNotesUrl: string;
}

function formatDate(raw: string): string {
  try {
    const d = new Date(raw);
    return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
  } catch {
    return raw;
  }
}

function extractTag(xml: string, tag: string): string {
  const re = new RegExp(`<${tag}[^>]*><!\\[CDATA\\[([\\s\\S]*?)\\]\\]><\\/${tag}>|<${tag}[^>]*>([\\s\\S]*?)<\\/${tag}>`, 'i');
  const m = xml.match(re);
  return (m ? (m[1] ?? m[2] ?? '') : '').trim();
}

function extractAttr(xml: string, tag: string, attr: string): string {
  const re = new RegExp(`<${tag}[^>]*\\s${attr}="([^"]*)"`, 'i');
  const m = xml.match(re);
  return m ? m[1].trim() : '';
}

function mdUrlToGitHub(url: string): string {
  // https://grayking-creator.github.io/openclaw-podcast/episode_002.md
  // ‚Üí https://github.com/grayking-creator/openclaw-podcast/blob/main/episode_002.md
  const m = url.match(/https:\/\/([^.]+)\.github\.io\/([^/]+)\/(.+)/);
  if (m) {
    return `https://github.com/${m[1]}/${m[2]}/blob/main/${m[3]}`;
  }
  return url;
}

let episodes: Episode[] = [];
let fetchError = false;

try {
  const res = await fetch(feedUrl);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const xml = await res.text();

  // Split into <item> blocks (strip channel-level content first)
  const channelMatch = xml.match(/<channel[^>]*>([\s\S]*?)<\/channel>/i);
  const channelXml = channelMatch ? channelMatch[1] : xml;

  const itemRegex = /<item>([\s\S]*?)<\/item>/gi;
  let m: RegExpExecArray | null;

  while ((m = itemRegex.exec(channelXml)) !== null) {
    const item = m[1];

    const title = extractTag(item, 'title');
    const description = extractTag(item, 'description');
    const pubDateRaw = extractTag(item, 'pubDate');
    const audioUrl = extractAttr(item, 'enclosure', 'url');
    const duration = extractTag(item, 'itunes:duration');
    const episodeNumStr = extractTag(item, 'itunes:episode');
    const link = extractTag(item, 'link');
    const showNotesUrl = mdUrlToGitHub(link);
    const pubDate = formatDate(pubDateRaw);
    const episodeNum = parseInt(episodeNumStr, 10) || 0;

    episodes.push({ episodeNum, title, description, pubDate, audioUrl, duration, showNotesUrl });
  }

  // Sort newest first
  episodes.sort((a, b) => b.episodeNum - a.episodeNum);

} catch (err) {
  fetchError = true;
  console.error('[podcasts.astro] RSS fetch failed:', err);
}
---

<Layout title="Podcasts | Toby on Fitness Tech" description="OpenClaw Daily ‚Äî your AI-hosted podcast covering the latest in fitness tech, local AI, hardware, and the OpenClaw ecosystem. Hosted by Nova & Alloy.">
  <div class="max-w-4xl mx-auto px-4 py-12">

    <!-- Hero -->
    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-blue-500 to-purple-500 bg-clip-text text-transparent">
        üéôÔ∏è OpenClaw Daily Podcast
      </h1>
      <p class="text-neutral-400 text-lg mb-6 max-w-2xl mx-auto">
        AI-hosted daily episodes covering fitness tech, local AI, hardware, security, and the OpenClaw ecosystem ‚Äî fresh takes every day.
      </p>
      <!-- Hosts badge -->
      <span class="bg-blue-500/10 border border-blue-500/20 text-blue-300 text-sm px-3 py-1 rounded-full inline-block">
        üé§ Hosts: Nova &amp; Alloy
      </span>
    </div>

    <!-- RSS Subscribe card -->
    <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 mb-10 flex flex-col sm:flex-row items-start sm:items-center gap-3">
      <div class="flex-1">
        <p class="text-blue-400 text-sm font-semibold mb-1">üì° Subscribe via RSS</p>
        <code class="text-neutral-300 text-xs break-all select-all">{rssFeed}</code>
      </div>
      <a
        href={rssFeed}
        target="_blank"
        rel="noopener noreferrer"
        class="shrink-0 bg-blue-600 hover:bg-blue-500 text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors"
      >
        Open Feed
      </a>
    </div>

    <!-- Episode list -->
    {fetchError ? (
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-6 mb-4 text-center">
        <p class="text-neutral-400 text-sm">‚ö†Ô∏è Episodes temporarily unavailable. Please check back soon.</p>
      </div>
    ) : episodes.length === 0 ? (
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-6 mb-4 text-center">
        <p class="text-neutral-400 text-sm">No episodes found in the feed yet.</p>
      </div>
    ) : (
      <div class="space-y-4">
        {episodes.map((ep) => (
          <article class="bg-neutral-900 border border-neutral-800 rounded-xl p-6 mb-4">
            <!-- Episode badge -->
            <span class="bg-blue-500/10 text-blue-400 text-xs font-medium px-2 py-1 rounded-full">
              Episode {ep.episodeNum}
            </span>

            <!-- Title -->
            <h2 class="text-xl font-bold text-white mt-2 mb-2">
              {ep.title.replace(/^Episode \d+:\s*/i, '')}
            </h2>

            <!-- Description -->
            <p class="text-neutral-400 text-sm leading-relaxed mb-3">
              {ep.description}
            </p>

            <!-- Meta -->
            <p class="text-neutral-500 text-xs mb-4">
              {ep.duration} &nbsp;¬∑&nbsp; {ep.pubDate}
            </p>

            <!-- Actions -->
            <div class="mt-2">
              {/* Primary listen button */}
              <a
                href={ep.audioUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-xl font-semibold text-white text-sm transition-all duration-200 hover:scale-[1.01] mb-2"
              >
                üéß Listen
              </a>
              {/* Secondary row */}
              <div class="grid grid-cols-2 gap-2">
                <a
                  href={`/podcasts/episode-${ep.episodeNum}/`}
                  class="flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg text-xs font-medium bg-neutral-800 border border-neutral-700 text-neutral-400 hover:text-white hover:border-neutral-500 transition-all"
                >
                  üìÑ Show Notes
                </a>
                <a
                  href={`/podcasts/episode-${ep.episodeNum}/?tab=transcript`}
                  class="flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg text-xs font-medium bg-neutral-800 border border-neutral-700 text-neutral-400 hover:text-white hover:border-neutral-500 transition-all"
                >
                  üìù Transcript
                </a>
              </div>
            </div>
          </article>
        ))}
      </div>
    )}

    <!-- Footer note -->
    <p class="text-center text-neutral-600 text-xs mt-12">
      Episodes generated by OpenClaw AI ¬∑ Voices by OpenAI TTS
    </p>

  </div>
</Layout>
