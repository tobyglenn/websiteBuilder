---
import Layout from '../../layouts/Layout.astro';
import VideoPlayer from '../../components/VideoPlayer.jsx';
import RelatedVideos from '../../components/RelatedVideos.jsx';
import { VIDEOS } from '../../data/mock.js';
import { Share2, ThumbsUp, Calendar, Eye, MessageSquare, FileText } from 'lucide-react';

// Load all transcript files at build time
const transcriptFiles = import.meta.glob('../../data/transcripts/*.txt', { query: '?raw', import: 'default', eager: true });

export function getStaticPaths() {
  return VIDEOS.map(video => ({
    params: { id: video.id },
    props: { video },
  }));
}

const { video } = Astro.props;

// Resolve transcript content
let transcriptContent = null;
if (video.transcript_file) {
  const key = `../../data/transcripts/${video.transcript_file}`;
  const raw = transcriptFiles[key];
  if (raw) {
    // Strip header lines (Title:, Date:, Video ID:, URL:, Source:, ---)
    transcriptContent = raw
      .split('\n')
      .filter(line => !line.startsWith('Title:') && !line.startsWith('Date:') && !line.startsWith('Video ID:') && !line.startsWith('URL:') && !line.startsWith('Source:') && !line.startsWith('---'))
      .join('\n')
      .trim();
  }
}

// Calculate "related" videos - same category preference, excluding current
const relatedVideos = VIDEOS.filter(v => v.id !== video.id).slice(0, 8);
---

<Layout 
  title={`${video.title} - TobyOnFitnessTech`}
  description={video.description?.slice(0, 155) || video.title}
  image={video.thumbnail}
  ogType="video.other"
>
  <div class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      {/* Main Content Column */}
      <div class="lg:col-span-2 space-y-6">
        
        {/* Video Player */}
        {video.is_live ? (
          <div id="live-player-container" data-video-id={video.id}>
            <a
              href={`https://www.youtube.com/watch?v=${video.id}`}
              target="_blank"
              rel="noopener noreferrer"
              class="group relative block w-full pb-[56.25%] h-0 overflow-hidden rounded-xl shadow-2xl bg-black"
            >
              {/* Thumbnail background */}
              <img
                src={video.thumbnail}
                alt={video.title}
                class="absolute inset-0 w-full h-full object-cover opacity-80 group-hover:opacity-60 transition-opacity duration-300"
              />
              {/* Dark overlay */}
              <div class="absolute inset-0 bg-black/40 group-hover:bg-black/50 transition-colors" />
              {/* LIVE badge */}
              <div class="absolute top-4 left-4 flex items-center gap-1.5 bg-red-600 text-white text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wide shadow-lg">
                <span class="w-2 h-2 rounded-full bg-white animate-pulse" />
                Live / Scheduled
              </div>
              {/* Play button + CTA */}
              <div class="absolute inset-0 flex flex-col items-center justify-center gap-4">
                <div class="bg-red-600/90 hover:bg-red-500 p-5 rounded-full shadow-2xl backdrop-blur-sm transition-transform group-hover:scale-110 duration-300">
                  <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="white" class="ml-1"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                </div>
                <span class="bg-black/70 backdrop-blur-sm text-white text-sm font-bold px-5 py-2 rounded-full border border-white/20">
                  Watch on YouTube →
                </span>
              </div>
            </a>
          </div>
          <script is:inline>
            (function () {
              var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
              if (!isSafari) {
                var container = document.getElementById('live-player-container');
                if (container) {
                  var videoId = container.getAttribute('data-video-id');
                  container.innerHTML =
                    '<div class="relative pb-[56.25%] h-0 overflow-hidden rounded-xl shadow-2xl bg-black">' +
                    '<iframe class="absolute top-0 left-0 w-full h-full"' +
                    ' src="https://www.youtube.com/embed/' + videoId + '?rel=0&autoplay=0"' +
                    ' title="YouTube video player"' +
                    ' frameborder="0"' +
                    ' allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"' +
                    ' allowfullscreen></iframe>' +
                    '</div>';
                }
              }
            })();
          </script>
        ) : (
          <VideoPlayer client:visible videoId={video.id} />
        )}
        
        {/* Video Title & Meta */}
        <div>
          <h1 class="text-2xl md:text-3xl font-bold mb-4 leading-tight">{video.title}</h1>
          
          <div class="flex flex-wrap items-center justify-between gap-4 border-b border-neutral-800 pb-4 mb-6">
            <div class="flex items-center gap-4 text-sm text-neutral-400">
                {video.views && video.views !== '0' && (
                  <span class="flex items-center gap-1"><Eye size={16} /> {parseInt(video.views).toLocaleString()} views</span>
                )}
                <span class="flex items-center gap-1"><Calendar size={16} /> {video.published_at}</span>
            </div>
            
            <div class="flex items-center gap-2">
                <button class="flex items-center gap-2 px-4 py-2 bg-neutral-800 hover:bg-neutral-700 rounded-full text-sm font-medium transition-colors">
                    <ThumbsUp size={18} /> Like
                </button>
                <button class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-full text-sm font-medium transition-colors">
                    <Share2 size={18} /> Share
                </button>
            </div>
          </div>

          {/* Description */}
          {video.description && (
            <div class="bg-neutral-900/50 p-6 rounded-xl border border-neutral-800">
              <h3 class="font-semibold mb-2">Description</h3>
              <p class="text-neutral-300 leading-relaxed whitespace-pre-line">
                {video.description}
              </p>
              {video.tags && video.tags.length > 0 && (
                <div class="mt-4 flex flex-wrap gap-2">
                  {video.tags.map(tag => (
                    <span class="text-xs bg-neutral-800 text-neutral-400 px-2 py-1 rounded-full">#{tag}</span>
                  ))}
                </div>
              )}
            </div>
          )}
          
          {/* Transcript Section */}
          <div class="mt-6 border-t border-neutral-800 pt-4">
            <details class="group">
                <summary class="flex items-center justify-between cursor-pointer list-none text-neutral-400 hover:text-white font-medium py-2">
                    <span class="flex items-center gap-2">
                      <FileText size={16} />
                      {transcriptContent ? 'Show Transcript' : 'Transcript'}
                    </span>
                    <span class="transition group-open:rotate-180">
                        <svg fill="none" height="24" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="24"><path d="M6 9l6 6 6-6"></path></svg>
                    </span>
                </summary>
                <div class="mt-4 text-sm leading-relaxed">
                  {transcriptContent ? (
                    <div class="bg-neutral-900/50 rounded-xl border border-neutral-800 p-6 max-h-96 overflow-y-auto">
                      <p class="text-neutral-300 whitespace-pre-wrap">{transcriptContent}</p>
                    </div>
                  ) : (
                    <p class="text-neutral-500 italic">Transcript not available for this video.</p>
                  )}
                </div>
            </details>
          </div>

          {/* YouTube Comments Note */}
          <div class="mt-6 border-t border-neutral-800 pt-4">
            <h3 class="text-lg font-bold mb-3 flex items-center gap-2 text-neutral-300">
                <MessageSquare size={18} /> Comments
            </h3>
            <div class="bg-neutral-900/50 rounded-xl p-6 border border-neutral-800 text-center">
              <p class="text-neutral-400 text-sm mb-3">
                Join the conversation on YouTube.
              </p>
              <a 
                href={`https://www.youtube.com/watch?v=${video.id}`} 
                target="_blank" 
                rel="noopener noreferrer"
                class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-lg transition-colors"
              >
                View & Comment on YouTube →
              </a>
            </div>
          </div>
        </div>
        
      </div>

      {/* Sidebar Column */}
      <div class="lg:col-span-1">
        <div class="sticky top-24">
            <h3 class="text-lg font-bold mb-4 text-neutral-200">Related Videos</h3>
            <div class="flex flex-col gap-4">
                 {relatedVideos.slice(0, 5).map(v => (
                     <a href={`/video/${v.id}`} class="flex gap-3 group">
                        <div class="relative w-40 flex-shrink-0 aspect-video rounded-lg overflow-hidden">
                             <img src={v.thumbnail} class="w-full h-full object-cover group-hover:scale-105 transition-transform" alt={v.title} loading="lazy" />
                             {v.duration_formatted && (
                               <span class="absolute bottom-1 right-1 bg-black/80 text-[10px] px-1 rounded text-white">{v.duration_formatted}</span>
                             )}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-semibold text-neutral-200 line-clamp-2 group-hover:text-blue-400 leading-snug">{v.title}</h4>
                            <p class="text-xs text-neutral-500 mt-1">{v.published_at}</p>
                        </div>
                     </a>
                 ))}
            </div>
            
            <div class="mt-8 bg-gradient-to-br from-blue-900/20 to-purple-900/20 p-6 rounded-xl border border-blue-500/20">
                <h4 class="font-bold text-white mb-2">Join the Newsletter</h4>
                <p class="text-xs text-neutral-400 mb-4">Get the latest fitness tech reviews delivered to your inbox.</p>
                <input type="email" placeholder="Email address" class="w-full bg-neutral-950 border border-neutral-800 rounded px-3 py-2 text-sm mb-2 focus:border-blue-500 outline-none" />
                <button class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 rounded transition-colors">Subscribe</button>
            </div>
        </div>
      </div>
    </div>
  </div>
</Layout>
